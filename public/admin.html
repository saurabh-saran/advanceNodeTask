<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Admin Panel</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .admin-container{max-width:900px;margin:40px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
    .row{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:10px 0}
    .muted{color:#666;font-size:12px}
    .live-badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:4px 8px;border-radius:999px;background:#e8fff1;border:1px solid #b7f0cf}
    .live-dot{width:8px;height:8px;border-radius:50%;background:#22c55e}
    .red{background:#ffe8e8;border-color:#ffc1c1}
    .dot-red{background:#ef4444}
    .topbar{display:flex;gap:10px;margin-bottom:12px}
    input[type="search"]{flex:1;padding:8px;border:1px solid #ddd;border-radius:8px}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useState, useMemo } = React;

    function LiveBadge({ isLive }) {
      return (
        <span className={`live-badge ${isLive ? '' : 'red'}`}>
          <span className={`live-dot ${isLive ? '' : 'dot-red'}`}></span>
          {isLive ? 'Live' : 'Offline'}
        </span>
      );
    }

    function Admin() {
      const [users, setUsers] = useState([]);
      const [liveMap, setLiveMap] = useState({});
      const [q, setQ] = useState("");

      useEffect(() => {
        fetch("/users").then(r => r.json()).then(setUsers);

        const socket = io();
        socket.on("updateUsers", (arr) => {
          const map = {};
          arr.forEach(u => { map[u.email] = true; });
          setLiveMap(map);
        });

        // Optional: admin as a "listener" only (no need to join room)
        return () => socket.close();
      }, []);

      const filtered = useMemo(() => {
        const s = q.trim().toLowerCase();
        if (!s) return users;
        return users.filter(u =>
          (u.firstName + " " + u.lastName).toLowerCase().includes(s) ||
          (u.email||"").toLowerCase().includes(s) ||
          (u.mobile||"").includes(s)
        );
      }, [q, users]);

      return (
        <div className="admin-container">
          <h2>Admin Panel – Registered Users</h2>
          <div className="topbar">
            <input type="search" placeholder="Search name / email / mobile" value={q} onChange={e=>setQ(e.target.value)}/>
            <button onClick={()=>window.location.href='index.html'}>Back</button>
          </div>

          {filtered.map(u => (
            <div className="row" key={u._id}>
              <div>
                <div><strong>{u.firstName} {u.lastName}</strong> &nbsp; <LiveBadge isLive={!!liveMap[u.email]} /></div>
                <div className="muted">{u.email} • {u.mobile} • {u.loginId}</div>
              </div>
              <div className="muted">{new Date(u.createdAt).toLocaleString()}</div>
            </div>
          ))}

          {filtered.length === 0 && <p className="muted" style={{marginTop:16}}>No users found.</p>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Admin/>);
  </script>
</body>
</html>
